### TCP协议介绍

TCP/IP分层模型中的传输层有两个十分重要的协议，它们分别是TCP和UDP。其中TCP是一种面向连接，提供可靠传输的协议。而UDP协议则不具备可靠性，它的很多控制细节是交由上层的应用程序去处理的。本文的重点在于TCP如何实现信息的可靠传输，已经在实现过程遇到问题，并如何解决的。

#### 如何保证可靠传输

首先可以考虑这个问题，如何才能实现信息的可靠传输？在日常的生活当中，当你和周围的人聊天时，你会希望他们及时的给予你反馈，从而让你知道他们是认真在听。这种反馈可能肢体上的语言，点头，也有可能是语言上，针对你的谈话的认同。如果你和一个人说了很多，但对方却没有任何反应，那十有八九对方已经走神了，即使不是，这个谈话也是让人很不舒服的，因为你不知道对方听进去没有。也就是说你说的信息可能并没有传输对方的脑子里。（当然这里得排除不敷衍和应付时的回答或点头。）

从这个角度出发，你的信息经过信号转换传输到对方的机器中，需要对方给予及时的答复是确认信息可靠传达的一种方式。基于这种想法，在发送每一个数据包时，其中会包括数据包的**序列号**，而应答机器会将序列号+1,回复给发送请求的机器。从而完成一次可靠的信息传输。这是TCP最基本的思想。但是仅仅这样并不能完全保证，不能保证是因为环境的复杂性。比如说：

- 传输过程中，信号由于某些原因其中的部分比特位发生了转变，这一部分是利用**检验和**来解决的，相对来说比较简单，不再细说。
- 传输与应答过程中，传输的数据包或确认应答的数据包在网络传输过程中丢失。TCP协议中利用**重发控制**来保证信息丢失过程中，信息可以再次发送，直至目标机器确认收到或者目标机器不可达。这里再介绍一个概念**重发超时**：也就是经过多长时间，发送机器没有收到目标机器的回复就再次发送没有发送成功的数据包，一般来说在BSD的Unix和Windows系统中，超时以为0.5秒为单位进行控制。一般来说初始值为6秒左右。

#### 如何提高传输效率

通过上述提到的机制，使得信息得以可靠的传输到目标机器，但是每发送一个数据包就需要等目标机器的应答，然后再发送下一个数据包的方式，显然效率不高，为了解决这个问题，TCP协议中引入了**窗口**的概念。也就是说发送端不需要在发送一个数据包后一直等待确认应答，而是在窗口允许的情况下，继续发送。而**窗口大小**就是指不需要等待确认应答而可以继续发送数据的最大值。这个机制的实现使用了大量的**缓冲区**。

[img](http://p3kb3ahmx.bkt.clouddn.com/26275986_1392626885IL2q.png)

如图所示，整个数据被分为了三部分：

- 已发送并收到确认的部分：该部分数据已经发送给目标机器并成功接收到应答信息，数据已经从缓冲区清除。
- 窗口部分：这个窗口内的数据，即使没有收到应答也可以被发送出去，但是数据如果在传输过程中丢失，仍然需要重传，因此缓冲区中应始终保存这里的数据，直至收到应答。如果收到确认应答，则将窗口滑动到对应的序列窗口下。因此这个又被称为滑动窗口协议。
- 未发送部分

滑动窗口中的重发控制：当某一数据包丢失后，发送端会一直收到丢失序列号 + 1的确认应答。因此，在窗口比较大，又出现数据包丢失的情况下，同一个序号的确认应答将会被重复发送，当发送端连续3次收到同一个确认应答后，就会将其对应的数据进行重发（高速重发控制）。

窗口大小的控制：因为接收端需要对数据进行处理，在高负荷的情况下，缓冲区可能很小，那此时接收端应该通知发送端所能接收的数据大小。所以在TCP首部，有一个字段专门用来通知窗口大小。

#### 如何避免网络堵塞

上述的方式解决了双机通信的网络问题，但是网络环境是很复杂的，如果在网络拥塞的情况下，发送端仍然不停发送数据包，这样会导致整个网络情况更糟。因此拥塞控制算法被提了出来。

在通信一开始，为了避免同时发送大量数据包，TCP会通过慢启动算法来对发送数据量进行控制。其算法如下：

- 先初始化cwnd（congestion window） = 1，表明可以传一个MSS（Maximum Segment Size）大小的数据。
- 每当收到一个确认应答时，cwnd++; 呈线性上升
- 每当过了一个往返时间，cwnd = cwnd * 2; 呈指数让升
- 当 cwnd >= ssthresh（slow start threshold）时，就会进入“拥塞避免算法”。

拥塞避免算法，当cwnd >= ssthresh时，每收到一个确认应答时cwnd = cwnd + 1/cwnd,而每当过了一个往返时间后，cwnd =  cwnd + 1,此时cwnd的增长是一个线性的关系，会慢慢的靠近网络吞吐的最优值

而当发生拥塞时，分两种情况，一种是由重复确认应答触发的高速重发，另一种是超时重发，这两种相比前一种的拥堵会更轻一些因些采用的策略也一不样，
超时重发说明网络的状态很不好，此时
- 令ssthresh = cwnd / 2
- cwnd = 1
- 进入慢启动

而在高速重发的情况下，TCP会认为你能收到3个ACK，所以网络也不是那么的糟，所以
- cwnd = sshthresh  + 3 * MSS （3的意思是确认有3个数据包被收到了）
- 重传Duplicated ACKs指定的数据包

#### 提高网络利用率的其他方式

这里先介绍一下Nagle算法：该算法的思想是如果发送端还有应该发送的数据，但这部分数据很少，则进行延迟发送。具体来说如果
- 已经发送的数据都已经收到确认应答时
- 可以发送最大段长度的数据时
这两个条件都不满足的话，则暂时等待一段时间以后再进行数据传送。这种方式会提高网络利用率，但同时也会发生延迟，因此在很多工业控制领域会关闭该算法。此外还有，延迟确认应答，捎带应答。这里不再详述。








