### HTTP请求到响应的详细过程

HTTP请求自然是建立在HTTP协议的基础上，而HTTP协议是建立在TCP/IP的基础上，本文会在TCP/IP分层模型的基础上详细阐述一个HTTP请求如何在网络中完成其响应的。

#### 实例分析

当你在浏览器中输入URL地址并按下回车后的那一刻，就会在你的机器与远程的服务器之间建立TCP连接，并利用这个连接进行数据的发送。

##### 客户端

- 应用层：在应用层的任务很简单，浏览器会依据HTTP协议，将你的这次请求封装成一个合法的HTTP请求。
- 传输层：传输层主要依赖TCP/UDP协议，在拿到应用层传来的数据并根据应用层的指示，负责建立连接、发送数据以及断开连接。TCP会负责将应用层传来的数据可靠的传输到目标服务器上。为了实现这一目标，该层会在应用层的数据上加上TCP首部，其中TCP首部中的关键信息包括源端口号和目标端口号，序号以及检验和(检验数据传输正确与否)
- 网络层：IP层会在传输层的基础上加上IP首部，其中包括发送端的IP地址以及接收端的IP地址。
- 数据链路层：在网络层数据的基础上，添加数据链路层的首部（比如以太网，无线通信协议），其中包括发送端的MAC地址，接收端MAC地址以及相应的数据链路层协议类型。
- 物理层：将数据链路层生成的数据帧，转化为物理信号，比如电信号，电磁波，光信号等。再通过相应介质进行物理传输。

##### 路由器

目前的路由器的功能其实包括了集线器，交换机以及路由器的功能。在接收到客户端发来的物理信号后，先按各层协议从下往上进行解析。如果在数据链路层发现目标的MAC地址与当前的路由在同一数据链路中，可以直接将数据发往目标机器。但是往往并不是在同一数据链路上，那么接着进行解析到网络层，得到目标IP地址，根据路由器上的路由控制表，按照最长匹配原则，发往其他路由。通过这种方式，一步步将数据发往目标机器所在的数据链路，并通过对应路由将数据发给对应机器。

##### 服务端

服务端在接收到客户端发来的数据后，也同样按照各层协议从下往上的进行解析。物理层 - 数据链路层 - 网络层 - 传输层（确认属于哪个应用的数据，以及数据检验等）- 应用层（此处会根据Http协议，解析对应的参数，服务端根据URL路由匹配调用相应的程序去处理该请求，或者与数据库进行交换，并将结果返回。返回结果与客户端的请求发送类似，不再赘述。）

#### 牵涉的协议部分

DNS(Domain Name System):完成主机名称到IP地址的转换。因为人们更容易记住一些有意义的字符串，而非一串无意义的数字。因此，在上述过程中实际上还会有域名解析服务器的交互。

ARP(Address Resolution Protocol):该协议以IP地址为线索，返回应该接收该数据包的机器的MAC地址。因此在上述例子中，如果在网络层中不知道对应机器的MAC地址，会先通过ARP协议来得到接收机器的MAC地址，并将其交由数据链路层封装在链路层首部。

TCP协议：实现数据包的可靠传输，这一部分会详细在后续的文章详细介绍。

路由协议：根据此协议，生成合理的路由控制表。

#### 其他辅助协议
这里顺便提一下其他与IP相关的协议，可能不一定会用这个例子里。

- ICMP(Internet Control Message Protocol)：用来确认IP是否成功送达的目标地址，通知在发送过程中IP包被丢弃的具体原因，改善网络设置;
- NAT(Network Address Translation)：用于在本地网络中使用私有地址，而在连接互联网时转而使用全局IP地址的技术，类似的以及实现端口映射的NAPT。
- DHCP(Dynamic Host Configuration Protocol): 动态IP地址分配。






